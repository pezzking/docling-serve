name: "Create Release"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (do not push changes)'
        required: false
        type: boolean
        default: false

jobs:
  code-checks:
    uses: ./.github/workflows/job-checks.yml

  release:
    needs: [code-checks]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 1.2.0)"
            exit 1
          fi
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "TAG_NAME=v${VERSION}" >> "$GITHUB_ENV"

      - name: Check if tag already exists
        run: |
          if git rev-parse "${{ env.TAG_NAME }}" >/dev/null 2>&1; then
            echo "Error: Tag ${{ env.TAG_NAME }} already exists"
            exit 1
          fi

      - name: Install uv and set the python version
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --only-dev

      - name: Update package version
        run: |
          uvx --from=toml-cli toml set --toml-path=pyproject.toml project.version "${{ env.VERSION }}"
          uv lock --upgrade-package docling-serve

      - name: Generate release notes
        id: release_notes
        run: |
          # Extract docling packages and versions from uv.lock
          DOCVERSIONS=$(uvx --with toml python3 - <<'PY'
          import toml
          data = toml.load("uv.lock")
          for pkg in data.get("package", []):
              if pkg["name"].startswith("docling"):
                  print(f"- {pkg['name']} {pkg['version']}")
          PY
          )

          # Create release notes file
          REL_NOTES=$(mktemp)

          # Try to get unreleased changelog, fallback to empty if none
          uv run --no-sync semantic-release changelog --unreleased > "${REL_NOTES}" 2>/dev/null || echo "No unreleased changes detected" > "${REL_NOTES}"

          # Append docling versions
          {
            cat "${REL_NOTES}"
            printf "\n### Docling libraries included in this release:\n"
            printf "%s\n" "${DOCVERSIONS}"
          } > release_notes.md

          echo "Generated release notes:"
          cat release_notes.md

      - name: Update changelog
        run: |
          CHGLOG_FILE="CHANGELOG.md"
          RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ env.TAG_NAME }}"

          # Create new changelog entry
          TMP_CHGLOG=$(mktemp)
          {
            printf "## [${{ env.TAG_NAME }}](${RELEASE_URL}) - $(date -Idate)\n\n"
            cat release_notes.md
            printf "\n"
            cat "${CHGLOG_FILE}"
          } > "${TMP_CHGLOG}"

          mv "${TMP_CHGLOG}" "${CHGLOG_FILE}"

      - name: Commit version bump
        if: ${{ !inputs.dry_run }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add pyproject.toml uv.lock CHANGELOG.md
          git commit -m "chore: bump version to ${{ env.VERSION }} [skip ci]"
          git push origin main

      - name: Create GitHub release
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ env.TAG_NAME }}" \
            --title "${{ env.TAG_NAME }}" \
            --notes-file release_notes.md

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "=== DRY RUN - No changes pushed ==="
          echo "Would create release: ${{ env.TAG_NAME }}"
          echo ""
          echo "=== Version changes ==="
          git diff pyproject.toml
          echo ""
          echo "=== Release notes ==="
          cat release_notes.md
